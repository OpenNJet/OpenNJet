@startuml
hide footbox
actor operator as o #green
participant "ctrl(域名解析)" as ctrl #pink
participant "pa" as pa
collections "upstream内存zone" as zone #lightyellow
database "upstream 指令持久化文件" as ups_file #2B99B9
participant "域名server" as server #Lightblue



o->ctrl: delete 删除请求: 
ctrl->pa:delete 删除请求:
activate pa
alt 删除ip,无业务
    pa->zone: 删除upstream 上的ip,从upstream 列表删除
    pa->zone:更新upstream 的update_id
else 删除ip,有业务
    pa->zone: 设置peer,down=1,del_pending=1,不从upstream 列表删除
    pa->zone:更新upstream 的update_id
else 删除域名
   pa->zone: 添加删除域名消息,到公用upstream的消息队列
end
alt 需要持久化
    pa->ups_file: 写文件(目前没有处理del_pending,该状态的还是会被保存todo).
end
pa->ctrl: 返回delete 结果
ctrl->o: 返回delete 结果
deactivate pa


ctrl<-[#red]>o zone:定时查询/处理删除域名
activate ctrl
ctrl->zone:删除域名timer
ctrl->zone:删除域名信息parent_node。
alt 删除ip,无业务
    ctrl->zone: 删除upstream 上的ip,从upstream 列表删除
else 删除ip,有业务
    ctrl->zone: 设置peer,down=1,del_pending=1,不从upstream 列表删除
end
ctrl->zone:更新upstream 的update_id
deactivate ctrl

ctrl<-[#red]>o server:定时域名解析
activate ctrl
alt  删除ip,无业务
    ctrl->zone: 删除upstream 上的ip,从upstream 列表删除
else 删除ip,有业务
    ctrl->zone: 设置peer,down=1,del_pending=1,不从upstream 列表删除
else 添加ip
    ctrl->zone: 添加到upstream 列表
end
ctrl->zone:更新upstream 的update_id
deactivate ctrl


o->ctrl: post/get/patch/delete请求: 
ctrl->pa:post/get/patch/delete请求:
pa->pa:  处理请求,并检查peer 状态del_pending=1,peer->conns=0,无业务时删除,并释放共享内存。
pa->ctrl:返回结果
ctrl->o:返回结果
@enduml