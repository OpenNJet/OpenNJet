@startuml
hide footbox
actor operator as o #green
participant "ctrl(域名解析)" as ctrl #pink
participant "pa" as pa
collections "upstream内存zone" as zone #lightyellow
participant "域名server" as server #Lightblue
database "upstream 指令持久化文件" as ups_file #2B99B9
participant "worker" as worker


o->ctrl: post/patch请求: 
ctrl->pa:post/patch请求:
activate pa
alt 添加ip
    pa->zone: 添加/修改 upstream 上的ip
    pa->zone:更新upstream 的update_id
else 添加域名
   pa->zone: 添加新增/修改域名消息,到公用的upstream的消息队列
end
alt 需要持久化
    pa->ups_file: 写文件
end
pa->ctrl: 返回post/patch 结果
ctrl->o: 返回post/patch 结果
deactivate pa
o->ctrl: delete 删除请求: 
ctrl->pa:delete 删除请求:
activate pa
alt 删除ip
    pa->zone: 删除upstream 上的ip
    pa->zone:更新upstream 的update_id
else 删除域名
   pa->zone: 添加删除域名消息,到公用upstream的消息队列
end
alt 需要持久化
    pa->ups_file: 写文件
end
pa->ctrl: 返回delete 结果
ctrl->o: 返回delete 结果
deactivate pa


ctrl<-[#red]>o zone:定时查询
activate ctrl
alt 新增域名
    ctrl->zone:保存域名信息作为parent_node。
    ctrl->ctrl:开启定时器
    ctrl->server: 查询域名
    server->ctrl: ip 信息
    ctrl->zone:根据变更，添加/删除ip
else 修改域名（权重等基本信息,只对新增ip 生效）
     ctrl->zone:保存域名信息作为parent_node。
else 删除域名
    ctrl->zone:删除域名timer
    ctrl->zone:删除域名信息parent_node。
    ctrl->zone:删除upstream 上的ip
end
ctrl->zone:更新upstream 的update_id

deactivate ctrl
o->worker: http 业务请求: 
activate worker

zone->worker: 对比upstream本地update_id和共享内存update_id
alt update_id不一致 && 有本地副本数据
    worker->worker: 根据upstream 算法需要，更新自己本地副本数据。
else 一致/没有本地副本数据
   worker->worker:不处理
end
@enduml