@startuml
hide footbox
actor operator as o
participant "pa" as pa
participant "mqtt" as mqtt
participant "worker1" as worker1
participant "worker2" as worker2
participant "ctrl" as ctrl
participant "其他worker" as other_worker


activate pa
o->pa: put 删除请求:
alt upstream 不存在
    pa->o: 删除失败
else upstream 为静态
  pa->o: 删除失败
else upstream ref_count > 1
  pa->o: 删除失败,is using
end 
pa->pa: njt_share_slab_mark_pool_delete 关闭zone
pa->pa: njt_share_slab_free_pool zone
alt upstream zone 引用 > 0
    pa->pa: 无操作
else upstream zone 引用 == 0
  pa->pa: free zone
end
pa->mqtt: delete upstream topic
mqtt->worker1: delete upstream topic
mqtt->worker2: delete upstream topic
mqtt->ctrl: delete upstream topic
mqtt->other_worker: delete upstream topic
pa->o: 删除成功
deactivate pa

activate worker1
worker1->worker1: njt_share_slab_mark_pool_delete 关闭zone
alt 有业务
    worker1->worker1: 无操作
else 无业务
  worker1->worker1: njt_share_slab_free_pool zone
  worker1->worker1: free zone
end
o->worker1: 业务延迟退出
  worker1->worker1: njt_share_slab_free_pool zone
  worker1->worker1: free zone

@enduml