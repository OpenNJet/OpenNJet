@startuml
hide footbox
actor operator as o
participant "njet master" as njet
participant "njet pa" as pa
participant "njt_http_proxy_module 模块" as proxy_pass
participant "upstream 模块" as upstream
participant "共享内存" as shm

njet->njet:加载静态配置
njet->proxy_pass: proxy_pass 到ip
proxy_pass->upstream: 添加upstream
njet->proxy_pass: proxy_pass 到域名
proxy_pass->upstream: 添加upstream
njet->proxy_pass: proxy_pass 到upstream
proxy_pass->upstream: 添加upstream
njet->njet:遍历所有upstream
alt upstream ip/命名upstream
   njet->njet: 保存解析的ip 到 upstream 的peers 中
else upstream 域名
   njet->njet: 解析域名
   njet->njet: 保存解析的ip 到 upstream 的peers 中
end

o->pa: 动态指令proxy_pass 到域名
pa->proxy_pass:proxy_pass 到域名
proxy_pass->upstream:添加upstream
upstream->upstream: 查询共享内存。key=域名+port
alt 不存在
   upstream->upstream: 解析域名
   upstream->upstream: 保存解析的ip列表 到 upstream 的peers 中
   upstream->shm:保存到共享内存。key=域名+port. val=ip数组。(实现加锁put 函数,如果同时put,第一个put的为准,并返回第一个指针)
else 存在
   upstream->upstream: 共享内存的ip列表拷贝到upstream 的peers 中
end






@enduml