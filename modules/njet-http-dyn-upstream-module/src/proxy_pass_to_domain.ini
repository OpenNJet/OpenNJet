@startuml
hide footbox
actor operator as o
participant "njet master" as njet
participant "njet pa" as pa
participant "njt_http_proxy_module 模块" as proxy_pass
participant "upstream 模块" as upstream
participant "mqtt" as mqtt
participant "worker" as worker
participant "共享内存" as shm
activate njet
njet->njet:加载静态配置
njet->proxy_pass: proxy_pass 到ip
proxy_pass->upstream: 添加upstream
njet->proxy_pass: proxy_pass 到域名
proxy_pass->upstream: 添加upstream
njet->proxy_pass: proxy_pass 到upstream
proxy_pass->upstream: 添加upstream
njet->njet:遍历所有upstream
alt upstream ip/命名upstream
   njet->njet: 保存解析的ip 到 upstream 的peers 中
else upstream 域名
   njet->njet: 解析域名
   njet->njet: 保存解析的ip 到 upstream 的peers 中
end
deactivate njet

o->pa: 动态指令proxy_pass 到域名
activate pa
pa->proxy_pass:proxy_pass 到域名
proxy_pass->upstream:添加upstream
upstream->upstream: 查询共享内存。key=域名+port
alt 不存在
   upstream->upstream: 解析域名
   upstream->upstream: 保存解析的ip列表 到 upstream 的peers 中
   upstream->shm:保存到共享内存。key=域名+port. val=ip数组。(实现加锁put 函数,如果多个同时put,第一个put的为准,并返回第一个指针)
else 存在
   upstream->upstream: 共享内存的ip列表拷贝到upstream 的peers 中
end
pa->mqtt: 发布topic
deactivate pa
mqtt->worker: 通知worker 加载proxy_pass
activate worker
worker->proxy_pass:proxy_pass 到域名
proxy_pass->upstream:添加upstream
upstream->upstream: 查询共享内存。key=域名+port
alt 存在
    upstream->upstream: 共享内存的ip列表拷贝到upstream 的peers 中
else 异常(不存在)
   upstream->upstream: 解析域名
   upstream->upstream: 保存解析的ip列表 到 upstream 的peers 中
   upstream->shm:保存到共享内存。key=域名+port. val=ip数组。(实现加锁put 函数,如果多个同时put,第一个put的为准,并返回第一个指针)
end
deactivate worker

o->njet: reload
activate njet
njet->njet:加载静态配置(流程同上) 
njet->pa:启动pa

activate pa
pa->pa: 加载mqtt 指令


njet->worker:启动worker
deactivate njet
activate worker
worker->worker: 加载mqtt 指令

worker->proxy_pass:proxy_pass 到域名
proxy_pass->upstream:添加upstream
upstream->upstream: 查询共享内存。key=域名+port
alt 不存在
   upstream->upstream: 解析域名
   upstream->upstream: 保存解析的ip列表 到 upstream 的peers 中
   upstream->shm:保存到共享内存。key=域名+port. val=ip数组。(实现加锁put 函数,如果多个同时put,第一个put的为准,并返回第一个指针)
else 存在
   upstream->upstream: 共享内存的ip列表拷贝到upstream 的peers 中
end
deactivate worker

pa->proxy_pass:proxy_pass 到域名
proxy_pass->upstream:添加upstream
upstream->upstream: 查询共享内存。key=域名+port
alt 存在
    upstream->upstream: 共享内存的ip列表拷贝到upstream 的peers 中
else 异常(不存在)
   upstream->upstream: 解析域名
   upstream->upstream: 保存解析的ip列表 到 upstream 的peers 中
   upstream->shm:保存到共享内存。key=域名+port. val=ip数组。(实现加锁put 函数,如果多个同时put,第一个put的为准,并返回第一个指针)
end
deactivate pa

o->pa: 删除proxy_pass(删除location,VS,proxy_pass 切换)
activate pa
pa->proxy_pass: proxy_pass 到域名
proxy_pass->upstream: 删除upstream
alt 无业务
   upstream->upstream: 删除upstream 对象
else 有业务
    upstream->upstream: 无操作
end
upstream->upstream: 删除域名对应的共享内存(多worker 都执行删除,只有第一个删除成功，其他直接返回)。

@enduml