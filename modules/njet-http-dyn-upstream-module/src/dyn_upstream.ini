@startuml
hide footbox
actor operator as o
participant "client" as client
participant "conneciton_pool" as c_pool
participant "request_pool" as r_pool
participant "location" as location
participant "proxy_pass" as proxy_pass
participant "proxy_upstream_conf" as upstream_conf
participant "upstream 1" as upstream
participant "upstream 2" as upstream2

upstream->upstream_conf: 注册upstream
upstream_conf->proxy_pass:注册反向代理。
location->proxy_pass: 绑定后端处理
proxy_pass->upstream:引用ref_count加1
client->c_pool: 1 tcp 连接
c_pool->r_pool: http_request
r_pool->location: url 路由 
proxy_pass->location: 绑定upstream_conf

activate location
location->location:初始化upstream_init_request
client->upstream: 指向upstream 绑定关系r->upstream->upstream。
deactivate location

o->location: 删除location 请求
alt 无业务
   location->location:无业务删除location

else 有业务
   location->location: location 置disable = 1
end

client->c_pool: 2.1 tcp 断开
c_pool->c_pool: 释放有业务的location,disable = 1,引用为 0
c_pool->c_pool: 释放有locaiton 引用的upstream,disable = 1,引用为 0
o->location: location proxy_pass 修改
location->upstream:引用ref_count减1
upstream2->proxy_pass: 注册upstream2
proxy_pass->location: 重新绑定upstream_conf

client->c_pool: 2.2 tcp 断开
c_pool->r_pool: 断开
r_pool->r_pool: request_pool 释放
alt r的upstream 与proxy_pass 不一致 
   r_pool->r_pool:删除无引用的upstream(需要保证没有在使用?)
else 一致
   r_pool->r_pool: 跳过
end
c_pool->c_pool: 释放有业务的location,disable = 1,引用为 0
c_pool->c_pool: 释放有locaiton 引用的upstream,disable = 1,引用为 0








@enduml