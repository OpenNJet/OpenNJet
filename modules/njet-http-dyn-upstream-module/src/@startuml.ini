@startuml
hide footbox
actor operator as o
participant "pa" as pa
participant "upstream模块" as upstream
participant "upstream算法模块" as upstream_hash
participant "upstream zone模块" as upstream_zone
participant "upstream_dynamic_servers模块" as upstream_state
participant "其他worker" as other_worker


o->pa: post 添加请求: 
activate pa
alt upstream 存在
    pa->o: 添加失败
else upstream 不存在
   pa->pa: 生成add_ups.txt
end
pa->pa:加载配置开始
pa->upstream: 用动态pool 生成upstream 环境
pa->pa: upstream配置,加入upstreams 数组
pa->upstream_hash: 绑定upstream算法init_upstream,destroy_upstream
pa->upstream_state: server 持久化state 文件创建
pa->upstream_zone: 初始化shm_zone 的大小，名字等。
pa->pa:加载配置结束
pa->pa:加载共享内存zone
alt zone 不存在
   pa->pa: 分配共享内存shpool
   pa->pa: init_zone 到共享内存
else zone 存在
   pa->pa: 获取共享内存shpool
   pa->pa: 更新到upstream 配置
end
 pa->other_worker: 添加topic给其他worker
 pa->o: 添加成功

o->pa: put 删除请求:
alt upstream 不存在
    pa->o: 删除失败
else upstream 为静态
  pa->o: 删除失败
else upstream ref_count > 1
  pa->o: 删除失败,is using
end 
o->other_worker:删除topic给其他worker
pa->o: 删除成功

@enduml