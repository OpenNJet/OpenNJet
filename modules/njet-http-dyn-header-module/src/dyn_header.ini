@startuml
hide footbox
actor operator as o
participant "master" as master
collections "dyn_header 模块" as dyn_header #lightyellow
collections "dyn_accesslog 模块" as dyn_accesslog #lightyellow
participant "pa" as pa
participant "ctrl" as ctrl
participant "mqtt" as mqtt
participant "kv 模块" as kv
participant "worker" as worker

activate master
master->pa: 启动pa 进程
deactivate master

activate dyn_header
dyn_header->pa:注册regist_update_fullconfig(LOCATION_DEL_EVENT,"dyn_http_header") 
dyn_header->pa:注册regist_update_fullconfig(VS_DEL_EVENT,"dyn_http_header")
deactivate dyn_header

activate dyn_accesslog
dyn_accesslog->pa:注册regist_update_fullconfig(LOCATION_DEL_EVENT,"http_log")

dyn_accesslog->pa:注册regist_update_fullconfig(VS_DEL_EVENT,"http_log")
deactivate dyn_accesslog



activate o
o->ctrl: http请求删除location

activate ctrl
ctrl->mqtt:删除location mqtt 消息
deactivate ctrl
activate mqtt
mqtt->pa:删除location mqtt 消息
deactivate mqtt
activate pa
pa-[#red]>pa:查找location,并从队列移除,有业务也会移除,只是内存不释放
pa->mqtt:广播给worker删除动态location
deactivate pa
activate mqtt
mqtt->worker:worker删除动态location
deactivate mqtt
activate worker
worker->worker:查找location,并从队列移除,有业务也会移除,只是内存不释放
deactivate worker
pa-[#red]>pa:njt_http_object_dispatch_notice(LOCATION_DEL_EVENT,TOPIC_UPDATE,NULL)
group njt_http_object_dispatch_notice 处理
pa->pa:遍历健值LOCATION_DEL_EVENT 的注册队列,处理注册topic_key,例如:dyn_http_header,http_log
== 处理动态dyn_http_header ==
pa->kv:通过 topic_key="dyn_http_header",获取声明式全量配置方法:rpc_get_handler 以及 topic 值.
pa->pa:通过rpc_get_handler 获取全量配置,full_config_data
pa->mqtt: 发送full_config_data 到topic,持久化
mqtt->worker:发送full_config_data 到worker 进行更新
== 处理动态http_log ==
pa->kv:通过 topic_key="http_log",获取声明式全量配置方法:rpc_get_handler 以及 topic 值.
pa->pa:通过rpc_get_handler 获取全量配置数据.full_config_data
pa->mqtt: 发送full_config_data 到topic,持久化
mqtt->worker:发送full_config_data 到worker 进行更新
end
deactivate pa
deactivate o

activate o
o->ctrl: http请求删除VS
activate ctrl
ctrl->mqtt:删除VS mqtt 消息
deactivate ctrl
activate mqtt
mqtt->pa:删除VS mqtt 消息
deactivate mqtt
activate pa
pa-[#red]>pa:查找VS,并从数组中移除,有业务也会移除,只是内存不释放
pa->mqtt:广播给worker删除动态VS
deactivate pa
activate mqtt
mqtt->worker:worker删除动态VS
deactivate mqtt
activate worker
worker->worker:查找VS,并从数组中移除,有业务也会移除,只是内存不释放
deactivate worker

pa-[#red]>pa:njt_http_object_dispatch_notice(VS_DEL_EVENT,TOPIC_UPDATE,NULL)
group njt_http_object_dispatch_notice 处理
pa->pa:遍历健值VS_DEL_EVENT 的注册队列,处理注册topic_key,例如:dyn_http_header,http_log
== 处理动态dyn_http_header ==
pa->kv:通过 topic_key="dyn_http_header",获取声明式全量配置方法:rpc_get_handler 以及 topic 值.
pa->pa:通过rpc_get_handler 获取全量配置数据.full_config_data
pa->mqtt: 发送full_config_data 到topic
mqtt->worker:发送full_config_data 到worker 进行更新


== 处理动态http_log ==
pa->kv:通过 topic_key="http_log",获取声明式全量配置方法:rpc_get_handler 以及 topic 值.
pa->pa:通过rpc_get_handler 获取全量配置数据.full_config_data
pa->mqtt: 发送full_config_data 到topic
mqtt->worker:发送full_config_data 到worker 进行更新
end
deactivate pa



@enduml