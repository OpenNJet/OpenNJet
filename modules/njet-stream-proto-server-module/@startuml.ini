@startuml
hide footbox
actor operator as o
participant "worker1" as w1
participant "proto_server模块" as proxy
participant "tcc 脚本" as tcc
participant "mqtt" as s
participant "worker2" as w2
participant "worker...n" as wn
actor operator as other


o->w1: connect 请求: 
activate w1
w1->proxy: 处理connect 请求
proxy->proxy:加入本worker列表local_list{session_id=流水id,r}
note right
   
end note
o->w1: login 请求:
w1->proxy: 处理login 请求 
proxy->proxy:更新{session_id=data,r}
s->proxy:订阅topic=port+server_name/session_id
proxy->s:加 session_id,到 共享内存session_list


other->w2: connect 请求: 
activate w2
w2->proxy: 处理connect 请求
proxy->proxy:加入本worker列表local_list{session_id=流水id,r}
note right
   
end note
other->w2: login 请求:
w2->proxy: 处理login 请求 
proxy->proxy:更新{session_id=data,r}
s->proxy:订阅topic=port+server_name/session_id2
proxy->s:加 session_id2,到 共享内存session_list


o->w1: 客户列表查询
w1->proxy: 处理列表查询
proxy->o: 返回列表查询session_list, [session_id1,session_id2,session_id3]
o->w1: 发送消息给session_id2
w1->proxy: 处理消息发送
alt 在本worker1
    proxy->other: 查找session_id2,发送消息给session_id2
else 不在本worker
    proxy->s: topic=port+server_name/session_id2, mqtt消息= {s:session_id1,r:session_id2,content}
    s->w2:转发mqtt 消息到worker2
    w2->other: 查找session_id2,发送content 到session_id2
end
o->w1: 发送广播消息  
w1->proxy: 处理广播消息
proxy->s:发送topic=port+server_name, mqtt消息= {s:session_id1,r:0,exclue=0,content} 到mqtt
s->w2:转发mqtt 消息到worker2
w2->w2: 遍历local_list,本worker 广播。
s->wn:转发mqtt 消息到workern
wn->wn:遍历local_list,本worker 广播。
w1->w1:遍历local_list,本worker 广播。
w1->o: 发送到客户端
@enduml