
# Copyright (C) Igor Sysoev
# Copyright (C) Nginx, Inc.
# Copyright (C) TMLake, Inc.


if [ $EVENT_SELECT = NO -a $EVENT_FOUND = NO ]; then
    EVENT_SELECT=YES
fi

if [ $EVENT_SELECT = YES ]; then
    have=NJT_HAVE_SELECT . auto/have
    CORE_SRCS="$CORE_SRCS $SELECT_SRCS"
    EVENT_MODULES="$EVENT_MODULES $SELECT_MODULE"
fi


if [ $EVENT_POLL = NO -a $EVENT_FOUND = NO ]; then
    EVENT_POLL=YES
fi

if [ $EVENT_POLL = YES ]; then
    have=NJT_HAVE_POLL . auto/have
    CORE_SRCS="$CORE_SRCS $POLL_SRCS"
    EVENT_MODULES="$EVENT_MODULES $POLL_MODULE"
fi


if [ $NJT_TEST_BUILD_DEVPOLL = YES ]; then
    have=NJT_HAVE_DEVPOLL . auto/have
    have=NJT_TEST_BUILD_DEVPOLL . auto/have
    EVENT_MODULES="$EVENT_MODULES $DEVPOLL_MODULE"
    CORE_SRCS="$CORE_SRCS $DEVPOLL_SRCS"
fi


if [ $NJT_TEST_BUILD_EVENTPORT = YES ]; then
    have=NJT_HAVE_EVENTPORT . auto/have
    have=NJT_TEST_BUILD_EVENTPORT . auto/have
    EVENT_MODULES="$EVENT_MODULES $EVENTPORT_MODULE"
    CORE_SRCS="$CORE_SRCS $EVENTPORT_SRCS"
fi

if [ $NJT_TEST_BUILD_EPOLL = YES ]; then
    have=NJT_HAVE_EPOLL . auto/have
    have=NJT_HAVE_EPOLLRDHUP . auto/have
    have=NJT_HAVE_EPOLLEXCLUSIVE . auto/have
    have=NJT_HAVE_EVENTFD . auto/have
    have=NJT_TEST_BUILD_EPOLL . auto/have
    EVENT_MODULES="$EVENT_MODULES $EPOLL_MODULE"
    CORE_SRCS="$CORE_SRCS $EPOLL_SRCS"
fi

if [ $NJT_TEST_BUILD_SOLARIS_SENDFILEV = YES ]; then
    have=NJT_TEST_BUILD_SOLARIS_SENDFILEV . auto/have
    CORE_SRCS="$CORE_SRCS $SOLARIS_SENDFILEV_SRCS"
fi

if [ $DYNAMIC_POOL = YES ]; then
    have=NJT_DYNAMIC_POOL . auto/have
fi

if [ $HTTP = YES ]; then
    HTTP_MODULES=
    HTTP_DEPS=
    HTTP_INCS=

    njt_module_type=HTTP

    if :; then
        njt_module_name="njt_http_module \
                         njt_http_core_module \
                         njt_http_log_module \
                         njt_http_upstream_module"
        njt_module_incs="src/http src/http/modules"
        njt_module_deps="src/http/njt_http.h \
                         src/http/njt_http_request.h \
                         src/http/njt_http_config.h \
                         src/http/njt_http_core_module.h \
                         src/http/njt_http_cache.h \
                         src/http/njt_http_variables.h \
                         src/http/njt_http_script.h \
                         src/http/njt_http_upstream.h \
                         src/http/njt_http_upstream_round_robin.h \
                         src/http/modules/njt_http_dyn_module.h "
        njt_module_srcs="src/http/njt_http.c \
                         src/http/njt_http_core_module.c \
                         src/http/njt_http_special_response.c \
                         src/http/njt_http_request.c \
                         src/http/njt_http_parse.c \
                         src/http/modules/njt_http_log_module.c \
                         src/http/njt_http_request_body.c \
                         src/http/njt_http_variables.c \
                         src/http/njt_http_script.c \
                         src/http/njt_http_upstream.c \
                         src/http/njt_http_upstream_round_robin.c"
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi


    if [ $HTTP_CACHE = YES ]; then
        have=NJT_HTTP_CACHE . auto/have
        HTTP_SRCS="$HTTP_SRCS $HTTP_FILE_CACHE_SRCS"
    fi


    if [ $HTTP_V2 = YES -o $HTTP_V3 = YES ]; then
        HTTP_SRCS="$HTTP_SRCS $HTTP_HUFF_SRCS"
    fi


    # the module order is important
    #     njt_http_static_module
    #     njt_http_gzip_static_module
    #     njt_http_dav_module
    #     njt_http_autoindex_module
    #     njt_http_index_module
    #     njt_http_random_index_module
    #
    #     njt_http_access_module
    #     njt_http_realip_module
    #
    #
    # the filter order is important
    #     njt_http_write_filter
    #     njt_http_header_filter
    #     njt_http_chunked_filter
    #     njt_http_v2_filter
    #     njt_http_v3_filter
    #     njt_http_range_header_filter
    #     njt_http_gzip_filter
    #     njt_http_postpone_filter
    #     njt_http_ssi_filter
    #     njt_http_charset_filter
    #         njt_http_xslt_filter
    #         njt_http_image_filter
    #         njt_http_sub_filter
    #         njt_http_addition_filter
    #         njt_http_gunzip_filter
    #         njt_http_userid_filter
    #         njt_http_headers_filter
    #     njt_http_copy_filter
    #     njt_http_range_body_filter
    #     njt_http_not_modified_filter
    #     njt_http_slice_filter

    njt_module_type=HTTP_FILTER
    HTTP_FILTER_MODULES=

    njt_module_order="njt_http_static_module \
                      njt_http_gzip_static_module \
                      njt_http_dav_module \
                      njt_http_autoindex_module \
                      njt_http_index_module \
                      njt_http_random_index_module \
                      njt_http_access_module \
                      njt_http_realip_module \
                      njt_http_write_filter_module \
                      njt_http_header_filter_module \
                      njt_http_chunked_filter_module \
                      njt_http_v2_filter_module \
                      njt_http_v3_filter_module \
                      njt_http_range_header_filter_module \
                      njt_http_gzip_filter_module \
                      njt_http_postpone_filter_module \
                      njt_http_ssi_filter_module \
                      njt_http_charset_filter_module \
                      njt_http_xslt_filter_module \
                      njt_http_image_filter_module \
                      njt_http_sub_filter_module \
                      njt_http_addition_filter_module \
                      njt_http_gunzip_filter_module \
                      njt_http_userid_filter_module \
                      njt_http_headers_filter_module \
                      njt_http_copy_filter_module \
                      njt_http_range_body_filter_module \
                      njt_http_not_modified_filter_module \
                      njt_http_slice_filter_module"

    if :; then
        njt_module_name=njt_http_write_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/njt_http_write_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_header_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/njt_http_header_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_chunked_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_chunked_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_V2 = YES ]; then
        njt_module_name=njt_http_v2_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/v2/njt_http_v2_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_V2

        . auto/module
    fi

    if [ $HTTP_V3 = YES ]; then
        njt_module_name=njt_http_v3_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/v3/njt_http_v3_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_V3

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_range_header_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_range_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_GZIP = YES ]; then
        have=NJT_HTTP_GZIP . auto/have
        USE_ZLIB=YES

        njt_module_name=njt_http_gzip_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_gzip_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_GZIP

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_postpone_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/njt_http_postpone_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_SSI = YES ]; then
        have=NJT_HTTP_SSI . auto/have

        njt_module_name=njt_http_ssi_filter_module
        njt_module_incs=
        njt_module_deps=src/http/modules/njt_http_ssi_filter_module.h
        njt_module_srcs=src/http/modules/njt_http_ssi_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SSI

        . auto/module
    fi

    if [ $HTTP_CHARSET = YES ]; then
        njt_module_name=njt_http_charset_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_charset_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_CHARSET

        . auto/module
    fi

    if [ $HTTP_XSLT != NO ]; then
        njt_module_name=njt_http_xslt_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_xslt_filter_module.c
        njt_module_libs=LIBXSLT
        njt_module_link=$HTTP_XSLT

        . auto/module
    fi

    if [ $HTTP_IMAGE_FILTER != NO ]; then
        njt_module_name=njt_http_image_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_image_filter_module.c
        njt_module_libs=LIBGD
        njt_module_link=$HTTP_IMAGE_FILTER

        . auto/module
    fi

    if [ $HTTP_SUB = YES ]; then
        njt_module_name=njt_http_sub_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_sub_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SUB

        . auto/module
    fi

    if [ $HTTP_ADDITION = YES ]; then
        njt_module_name=njt_http_addition_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_addition_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_ADDITION

        . auto/module
    fi

    if [ $HTTP_GUNZIP = YES ]; then
        have=NJT_HTTP_GZIP . auto/have
        USE_ZLIB=YES

        njt_module_name=njt_http_gunzip_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_gunzip_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_GUNZIP

        . auto/module
    fi

    if [ $HTTP_USERID = YES ]; then
        njt_module_name=njt_http_userid_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_userid_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_USERID

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_headers_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_headers_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi


    njt_module_type=HTTP_INIT_FILTER
    HTTP_INIT_FILTER_MODULES=

    if :; then
        njt_module_name=njt_http_copy_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/njt_http_copy_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_range_body_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_not_modified_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_not_modified_filter_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_SLICE = YES ]; then
        njt_module_name=njt_http_slice_filter_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_slice_filter_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SLICE

        . auto/module
    fi


    njt_module_type=HTTP

    if [ $HTTP_V2 = YES ]; then
        have=NJT_HTTP_V2 . auto/have

        njt_module_name=njt_http_v2_module
        njt_module_incs=src/http/v2
        njt_module_deps="src/http/v2/njt_http_v2.h \
                         src/http/v2/njt_http_v2_module.h"
        njt_module_srcs="src/http/v2/njt_http_v2.c \
                         src/http/v2/njt_http_v2_table.c \
                         src/http/v2/njt_http_v2_encode.c \
                         src/http/v2/njt_http_v2_module.c"
        njt_module_libs=
        njt_module_link=$HTTP_V2

        . auto/module
    fi

    if [ $HTTP_V3 = YES ]; then
        USE_OPENSSL_QUIC=YES
        HTTP_SSL=YES

        have=NJT_HTTP_V3 . auto/have

        njt_module_name=njt_http_v3_module
        njt_module_incs=src/http/v3
        njt_module_deps="src/http/v3/njt_http_v3.h \
                         src/http/v3/njt_http_v3_encode.h \
                         src/http/v3/njt_http_v3_parse.h \
                         src/http/v3/njt_http_v3_table.h \
                         src/http/v3/njt_http_v3_uni.h"
        njt_module_srcs="src/http/v3/njt_http_v3.c \
                         src/http/v3/njt_http_v3_encode.c \
                         src/http/v3/njt_http_v3_parse.c \
                         src/http/v3/njt_http_v3_table.c \
                         src/http/v3/njt_http_v3_uni.c \
                         src/http/v3/njt_http_v3_request.c \
                         src/http/v3/njt_http_v3_module.c"
        njt_module_libs=
        njt_module_link=$HTTP_V3

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_static_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_static_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_GZIP_STATIC = YES ]; then
        have=NJT_HTTP_GZIP . auto/have

        njt_module_name=njt_http_gzip_static_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_gzip_static_module.c
        njt_module_libs=
        njt_module_link=$HTTP_GZIP_STATIC

        . auto/module
    fi

    if [ $HTTP_DAV = YES ]; then
        have=NJT_HTTP_DAV . auto/have

        njt_module_name=njt_http_dav_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_dav_module.c
        njt_module_libs=
        njt_module_link=$HTTP_DAV

        . auto/module
    fi

    if [ $HTTP_AUTOINDEX = YES ]; then
        njt_module_name=njt_http_autoindex_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_autoindex_module.c
        njt_module_libs=
        njt_module_link=$HTTP_AUTOINDEX

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_index_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_index_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_RANDOM_INDEX = YES ]; then
        njt_module_name=njt_http_random_index_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_random_index_module.c
        njt_module_libs=
        njt_module_link=$HTTP_RANDOM_INDEX

        . auto/module
    fi

    if [ $HTTP_MIRROR = YES ]; then
        njt_module_name=njt_http_mirror_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_mirror_module.c
        njt_module_libs=
        njt_module_link=$HTTP_MIRROR

        . auto/module
    fi

    if :; then
        njt_module_name=njt_http_try_files_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_try_files_module.c
        njt_module_libs=
        njt_module_link=YES

        . auto/module
    fi

    if [ $HTTP_AUTH_REQUEST = YES ]; then
        njt_module_name=njt_http_auth_request_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_auth_request_module.c
        njt_module_libs=
        njt_module_link=$HTTP_AUTH_REQUEST

        . auto/module
    fi

    if [ $HTTP_AUTH_BASIC = YES ]; then
        have=NJT_CRYPT . auto/have

        njt_module_name=njt_http_auth_basic_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_auth_basic_module.c
        njt_module_libs=$CRYPT_LIB
        njt_module_link=$HTTP_AUTH_BASIC

        . auto/module
    fi

    if [ $HTTP_ACCESS = YES ]; then
        njt_module_name=njt_http_access_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_access_module.c
        njt_module_libs=
        njt_module_link=$HTTP_ACCESS

        . auto/module
    fi

    if [ $HTTP_LIMIT_CONN = YES ]; then
        njt_module_name=njt_http_limit_conn_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_limit_conn_module.c
        njt_module_libs=
        njt_module_link=$HTTP_LIMIT_CONN

        . auto/module
    fi

    if [ $HTTP_LIMIT_REQ = YES ]; then
        njt_module_name=njt_http_limit_req_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_limit_req_module.c
        njt_module_libs=
        njt_module_link=$HTTP_LIMIT_REQ

        . auto/module
    fi

    if [ $HTTP_REALIP = YES ]; then
        have=NJT_HTTP_REALIP . auto/have
        have=NJT_HTTP_X_FORWARDED_FOR . auto/have

        njt_module_name=njt_http_realip_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_realip_module.c
        njt_module_libs=
        njt_module_link=$HTTP_REALIP

        . auto/module
    fi

    if [ $HTTP_STATUS = YES ]; then
        njt_module_name=njt_http_status_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_status_module.c
        njt_module_libs=
        njt_module_link=$HTTP_STATUS

        . auto/module
    fi

    if [ $HTTP_GEO = YES ]; then
        have=NJT_HTTP_X_FORWARDED_FOR . auto/have

        njt_module_name=njt_http_geo_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_geo_module.c
        njt_module_libs=
        njt_module_link=$HTTP_GEO

        . auto/module
    fi

    if [ $HTTP_GEOIP != NO ]; then
        have=NJT_HTTP_X_FORWARDED_FOR . auto/have

        njt_module_name=njt_http_geoip_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_geoip_module.c
        njt_module_libs=GEOIP
        njt_module_link=$HTTP_GEOIP

        . auto/module
    fi

    if [ $HTTP_MAP = YES ]; then
        njt_module_name=njt_http_map_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_map_module.c
        njt_module_libs=
        njt_module_link=$HTTP_MAP

        . auto/module
    fi

    if [ $HTTP_SPLIT_CLIENTS = YES ]; then
        njt_module_name=njt_http_split_clients_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_split_clients_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SPLIT_CLIENTS

        . auto/module
    fi

    if [ $HTTP_REFERER = YES ]; then
        njt_module_name=njt_http_referer_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_referer_module.c
        njt_module_libs=
        njt_module_link=$HTTP_REFERER

        . auto/module
    fi

    if [ $HTTP_REWRITE = YES -a $USE_PCRE != DISABLED ]; then
        USE_PCRE=YES

        njt_module_name=njt_http_rewrite_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_rewrite_module.c
        njt_module_libs=
        njt_module_link=$HTTP_REWRITE

        . auto/module
    fi

    if [ $HTTP_SSL = YES ]; then
        USE_OPENSSL=YES
        have=NJT_HTTP_SSL . auto/have

        njt_module_name=njt_http_ssl_module
        njt_module_incs=
        njt_module_deps=src/http/modules/njt_http_ssl_module.h
        njt_module_srcs=src/http/modules/njt_http_ssl_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SSL

        . auto/module
    fi

    if [ $HTTP_PROXY = YES ]; then
        have=NJT_HTTP_X_FORWARDED_FOR . auto/have

        njt_module_name=njt_http_proxy_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_proxy_module.c
        njt_module_libs=
        njt_module_link=$HTTP_PROXY

        . auto/module
    fi

    if [ $HTTP_FASTCGI = YES ]; then
        njt_module_name=njt_http_fastcgi_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_fastcgi_module.c
        njt_module_libs=
        njt_module_link=$HTTP_FASTCGI

        . auto/module
    fi

    if [ $HTTP_UWSGI = YES ]; then
        njt_module_name=njt_http_uwsgi_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_uwsgi_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UWSGI

        . auto/module
    fi

    if [ $HTTP_SCGI = YES ]; then
        njt_module_name=njt_http_scgi_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_scgi_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SCGI

        . auto/module
    fi

    if [ $HTTP_GRPC = YES -a $HTTP_V2 = YES ]; then
        njt_module_name=njt_http_grpc_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_grpc_module.c
        njt_module_libs=
        njt_module_link=$HTTP_GRPC

        . auto/module
    fi

    if [ $HTTP_PERL != NO ]; then
        njt_module_name=njt_http_perl_module
        njt_module_incs=src/http/modules/perl
        njt_module_deps=src/http/modules/perl/njt_http_perl_module.h
        njt_module_srcs=src/http/modules/perl/njt_http_perl_module.c
        njt_module_libs=PERL
        njt_module_link=$HTTP_PERL

        . auto/module
    fi

    if [ $HTTP_MEMCACHED = YES ]; then
        njt_module_name=njt_http_memcached_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_memcached_module.c
        njt_module_libs=
        njt_module_link=$HTTP_MEMCACHED

        . auto/module
    fi

    if [ $HTTP_EMPTY_GIF = YES ]; then
        njt_module_name=njt_http_empty_gif_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_empty_gif_module.c
        njt_module_libs=
        njt_module_link=$HTTP_EMPTY_GIF

        . auto/module
    fi

    if [ $HTTP_BROWSER = YES ]; then
        njt_module_name=njt_http_browser_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_browser_module.c
        njt_module_libs=
        njt_module_link=$HTTP_BROWSER

        . auto/module
    fi

    if [ $HTTP_SECURE_LINK = YES ]; then
        njt_module_name=njt_http_secure_link_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_secure_link_module.c
        njt_module_libs=
        njt_module_link=$HTTP_SECURE_LINK

        . auto/module
    fi

    if [ $HTTP_DEGRADATION = YES ]; then
        have=NJT_HTTP_DEGRADATION . auto/have

        njt_module_name=njt_http_degradation_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_degradation_module.c
        njt_module_libs=
        njt_module_link=$HTTP_DEGRADATION

        . auto/module
    fi

    if [ $HTTP_FLV = YES ]; then
        njt_module_name=njt_http_flv_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_flv_module.c
        njt_module_libs=
        njt_module_link=$HTTP_FLV

        . auto/module
    fi

    if [ $HTTP_MP4 = YES ]; then
        njt_module_name=njt_http_mp4_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_mp4_module.c
        njt_module_libs=
        njt_module_link=$HTTP_MP4

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_HASH = YES ]; then
        njt_module_name=njt_http_upstream_hash_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_hash_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_HASH

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_IP_HASH = YES ]; then
        njt_module_name=njt_http_upstream_ip_hash_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_ip_hash_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_IP_HASH

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_LEAST_CONN = YES ]; then
        njt_module_name=njt_http_upstream_least_conn_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_least_conn_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_LEAST_CONN

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_RANDOM = YES ]; then
        njt_module_name=njt_http_upstream_random_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_random_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_RANDOM

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_KEEPALIVE = YES ]; then
        njt_module_name=njt_http_upstream_keepalive_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_keepalive_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_KEEPALIVE

        . auto/module
    fi

    if [ $HTTP_UPSTREAM_ZONE = YES ]; then
        have=NJT_HTTP_UPSTREAM_ZONE . auto/have

        njt_module_name=njt_http_upstream_zone_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_upstream_zone_module.c
        njt_module_libs=
        njt_module_link=$HTTP_UPSTREAM_ZONE

        . auto/module
    fi

    if [ $HTTP_STUB_STATUS = YES ]; then
        have=NJT_STAT_STUB . auto/have

        njt_module_name=njt_http_stub_status_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=src/http/modules/njt_http_stub_status_module.c
        njt_module_libs=
        njt_module_link=$HTTP_STUB_STATUS

        . auto/module
    fi
fi


if [ $MAIL != NO ]; then
    MAIL_MODULES=
    MAIL_DEPS=
    MAIL_INCS=

    njt_module_type=MAIL
    njt_module_libs=
    njt_module_link=YES

    njt_module_order=

    njt_module_name="njt_mail_module njt_mail_core_module"
    njt_module_incs="src/mail"
    njt_module_deps="src/mail/njt_mail.h"
    njt_module_srcs="src/mail/njt_mail.c \
                     src/mail/njt_mail_core_module.c \
                     src/mail/njt_mail_handler.c \
                     src/mail/njt_mail_parse.c"

    . auto/module

    njt_module_incs=

    if [ $MAIL_SSL = YES ]; then
        USE_OPENSSL=YES
        have=NJT_MAIL_SSL . auto/have

        njt_module_name=njt_mail_ssl_module
        njt_module_deps=src/mail/njt_mail_ssl_module.h
        njt_module_srcs=src/mail/njt_mail_ssl_module.c

        . auto/module
    fi

    if [ $MAIL_POP3 = YES ]; then
        njt_module_name=njt_mail_pop3_module
        njt_module_deps=src/mail/njt_mail_pop3_module.h
        njt_module_srcs="src/mail/njt_mail_pop3_module.c \
                         src/mail/njt_mail_pop3_handler.c"

        . auto/module
    fi

    if [ $MAIL_IMAP = YES ]; then
        njt_module_name=njt_mail_imap_module
        njt_module_deps=src/mail/njt_mail_imap_module.h
        njt_module_srcs="src/mail/njt_mail_imap_module.c \
                         src/mail/njt_mail_imap_handler.c"

        . auto/module
    fi

    if [ $MAIL_SMTP = YES ]; then
        njt_module_name=njt_mail_smtp_module
        njt_module_deps=src/mail/njt_mail_smtp_module.h
        njt_module_srcs="src/mail/njt_mail_smtp_module.c \
                         src/mail/njt_mail_smtp_handler.c"

        . auto/module
    fi

    njt_module_name=njt_mail_auth_http_module
    njt_module_deps=
    njt_module_srcs=src/mail/njt_mail_auth_http_module.c

    . auto/module

    njt_module_name=njt_mail_proxy_module
    njt_module_deps=
    njt_module_srcs=src/mail/njt_mail_proxy_module.c

    . auto/module

    njt_module_name=njt_mail_realip_module
    njt_module_deps=
    njt_module_srcs=src/mail/njt_mail_realip_module.c

    . auto/module
fi


if [ $STREAM != NO ]; then
    STREAM_MODULES=
    STREAM_DEPS=
    STREAM_INCS=

    njt_module_type=STREAM
    njt_module_libs=
    njt_module_link=YES

    njt_module_order=

    njt_module_name="njt_stream_module \
                     njt_stream_core_module \
                     njt_stream_log_module \
                     njt_stream_proxy_module \
                     njt_stream_upstream_module \
                     njt_stream_write_filter_module"
    njt_module_incs="src/stream"
    njt_module_deps="src/stream/njt_stream.h \
                     src/stream/njt_stream_variables.h \
                     src/stream/njt_stream_script.h \
                     src/stream/njt_stream_upstream.h \
                     src/stream/njt_stream_upstream_round_robin.h \
                     src/stream/njt_stream_dyn_module.h"
    njt_module_srcs="src/stream/njt_stream.c \
                     src/stream/njt_stream_variables.c \
                     src/stream/njt_stream_script.c \
                     src/stream/njt_stream_handler.c \
                     src/stream/njt_stream_core_module.c \
                     src/stream/njt_stream_log_module.c \
                     src/stream/njt_stream_proxy_module.c \
                     src/stream/njt_stream_upstream.c \
                     src/stream/njt_stream_upstream_round_robin.c \
                     src/stream/njt_stream_write_filter_module.c"

    . auto/module

    njt_module_incs=

    if [ $STREAM_SSL = YES ]; then
        USE_OPENSSL=YES
        have=NJT_STREAM_SSL . auto/have

        njt_module_name=njt_stream_ssl_module
        njt_module_deps=src/stream/njt_stream_ssl_module.h
        njt_module_srcs=src/stream/njt_stream_ssl_module.c
        njt_module_libs=
        njt_module_link=$STREAM_SSL

        . auto/module
    fi

    if [ $STREAM_REALIP = YES ]; then
        njt_module_name=njt_stream_realip_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_realip_module.c
        njt_module_libs=
        njt_module_link=$STREAM_REALIP

        . auto/module
    fi

    if [ $STREAM_LIMIT_CONN = YES ]; then
        njt_module_name=njt_stream_limit_conn_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_limit_conn_module.c
        njt_module_libs=
        njt_module_link=$STREAM_LIMIT_CONN

        . auto/module
    fi

    if [ $STREAM_ACCESS = YES ]; then
        njt_module_name=njt_stream_access_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_access_module.c
        njt_module_libs=
        njt_module_link=$STREAM_ACCESS

        . auto/module
    fi

    if [ $STREAM_GEO = YES ]; then
        njt_module_name=njt_stream_geo_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_geo_module.c
        njt_module_libs=
        njt_module_link=$STREAM_GEO

        . auto/module
    fi

    if [ $STREAM_GEOIP != NO ]; then
        njt_module_name=njt_stream_geoip_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_geoip_module.c
        njt_module_libs=GEOIP
        njt_module_link=$STREAM_GEOIP

        . auto/module
    fi

    if [ $STREAM_MAP = YES ]; then
        njt_module_name=njt_stream_map_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_map_module.c
        njt_module_libs=
        njt_module_link=$STREAM_MAP

        . auto/module
    fi

    if [ $STREAM_SPLIT_CLIENTS = YES ]; then
        njt_module_name=njt_stream_split_clients_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_split_clients_module.c
        njt_module_libs=
        njt_module_link=$STREAM_SPLIT_CLIENTS

        . auto/module
    fi

    if [ $STREAM_RETURN = YES ]; then
        njt_module_name=njt_stream_return_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_return_module.c
        njt_module_libs=
        njt_module_link=$STREAM_RETURN

        . auto/module
    fi

    if [ $STREAM_SET = YES ]; then
        njt_module_name=njt_stream_set_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_set_module.c
        njt_module_libs=
        njt_module_link=$STREAM_SET

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_HASH = YES ]; then
        njt_module_name=njt_stream_upstream_hash_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_upstream_hash_module.c
        njt_module_libs=
        njt_module_link=$STREAM_UPSTREAM_HASH

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_LEAST_CONN = YES ]; then
        njt_module_name=njt_stream_upstream_least_conn_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_upstream_least_conn_module.c
        njt_module_libs=
        njt_module_link=$STREAM_UPSTREAM_LEAST_CONN

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_RANDOM = YES ]; then
        njt_module_name=njt_stream_upstream_random_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_upstream_random_module.c
        njt_module_libs=
        njt_module_link=$STREAM_UPSTREAM_RANDOM

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_ZONE = YES ]; then
        have=NJT_STREAM_UPSTREAM_ZONE . auto/have

        njt_module_name=njt_stream_upstream_zone_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_upstream_zone_module.c
        njt_module_libs=
        njt_module_link=$STREAM_UPSTREAM_ZONE

        . auto/module
    fi

    if [ $STREAM_SSL_PREREAD = YES ]; then
        njt_module_name=njt_stream_ssl_preread_module
        njt_module_deps=
        njt_module_srcs=src/stream/njt_stream_ssl_preread_module.c
        njt_module_libs=
        njt_module_link=$STREAM_SSL_PREREAD

        . auto/module
    fi
fi


#if [ -r $NJT_OBJS/auto ]; then
#    . $NJT_OBJS/auto
#fi


if test -n "$NJT_ADDONS"; then

    echo configuring additional modules

    for njt_addon_dir in $NJT_ADDONS
    do
        echo "adding module in $njt_addon_dir"

        njt_module_type=
        njt_module_name=
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=
        njt_module_libs=
        njt_module_order=
        njt_module_link=ADDON

        if test -f $njt_addon_dir/config; then
            . $njt_addon_dir/config

            echo " + $njt_addon_name was configured"

        else
            echo "$0: error: no $njt_addon_dir/config was found"
            exit 1
        fi
    done
fi


if test -n "$DYNAMIC_ADDONS"; then

    echo configuring additional dynamic modules

    for njt_addon_dir in $DYNAMIC_ADDONS
    do
        echo "adding module in $njt_addon_dir"

        njt_module_type=
        njt_module_name=
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=
        njt_module_libs=
        njt_module_order=
        njt_module_link=DYNAMIC

        if test -f $njt_addon_dir/config; then
            . $njt_addon_dir/config

            echo " + $njt_addon_name was configured"

        else
            echo "$0: error: no $njt_addon_dir/config was found"
            exit 1
        fi
    done
fi


if [ $USE_OPENSSL = YES ]; then
    njt_module_type=CORE
    njt_module_name=njt_openssl_module
    njt_module_incs=
    njt_module_deps=src/event/njt_event_openssl.h
    njt_module_srcs="src/event/njt_event_openssl.c
                     src/event/njt_event_openssl_stapling.c"
    njt_module_libs=
    njt_module_link=YES
    njt_module_order=

    . auto/module
fi


if [ $USE_OPENSSL_QUIC = YES ]; then
    njt_module_type=CORE
    njt_module_name=njt_quic_module
    njt_module_incs=
    njt_module_deps="src/event/quic/njt_event_quic.h \
                     src/event/quic/njt_event_quic_transport.h \
                     src/event/quic/njt_event_quic_protection.h \
                     src/event/quic/njt_event_quic_connection.h \
                     src/event/quic/njt_event_quic_frames.h \
                     src/event/quic/njt_event_quic_connid.h \
                     src/event/quic/njt_event_quic_migration.h \
                     src/event/quic/njt_event_quic_streams.h \
                     src/event/quic/njt_event_quic_ssl.h \
                     src/event/quic/njt_event_quic_tokens.h \
                     src/event/quic/njt_event_quic_ack.h \
                     src/event/quic/njt_event_quic_output.h \
                     src/event/quic/njt_event_quic_socket.h \
                     src/event/quic/njt_event_quic_openssl_compat.h"
    njt_module_srcs="src/event/quic/njt_event_quic.c \
                     src/event/quic/njt_event_quic_udp.c \
                     src/event/quic/njt_event_quic_transport.c \
                     src/event/quic/njt_event_quic_protection.c \
                     src/event/quic/njt_event_quic_frames.c \
                     src/event/quic/njt_event_quic_connid.c \
                     src/event/quic/njt_event_quic_migration.c \
                     src/event/quic/njt_event_quic_streams.c \
                     src/event/quic/njt_event_quic_ssl.c \
                     src/event/quic/njt_event_quic_tokens.c \
                     src/event/quic/njt_event_quic_ack.c \
                     src/event/quic/njt_event_quic_output.c \
                     src/event/quic/njt_event_quic_socket.c \
                     src/event/quic/njt_event_quic_openssl_compat.c"

    njt_module_libs=
    njt_module_link=YES
    njt_module_order=

    . auto/module

    if [ $QUIC_BPF = YES -a $SO_COOKIE_FOUND = YES ]; then
        njt_module_type=CORE
        njt_module_name=njt_quic_bpf_module
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs="src/event/quic/njt_event_quic_bpf.c \
                         src/event/quic/njt_event_quic_bpf_code.c"
        njt_module_libs=
        njt_module_link=YES
        njt_module_order=

        . auto/module

        have=NJT_QUIC_BPF . auto/have
    fi
fi


if [ $USE_PCRE = YES ]; then
    njt_module_type=CORE
    njt_module_name=njt_regex_module
    njt_module_incs=
    njt_module_deps=src/core/njt_regex.h
    njt_module_srcs=src/core/njt_regex.c
    njt_module_libs=
    njt_module_link=YES
    njt_module_order=

    . auto/module
fi


if [ $USE_NTLS = YES ]; then
    have=NJT_HTTP_MULTICERT . auto/have
    have=NJT_HAVE_NTLS . auto/have
fi


modules="$CORE_MODULES $EVENT_MODULES"


# thread pool module should be initialized after events
if [ $USE_THREADS = YES ]; then
    modules="$modules $THREAD_POOL_MODULE"
fi


if [ $HTTP = YES ]; then
    modules="$modules $HTTP_MODULES $HTTP_FILTER_MODULES \
             $HTTP_AUX_FILTER_MODULES $HTTP_INIT_FILTER_MODULES"

    NJT_ADDON_DEPS="$NJT_ADDON_DEPS \$(HTTP_DEPS)"
fi


if [ $MAIL != NO ]; then

    if [ $MAIL = YES ]; then
        modules="$modules $MAIL_MODULES"

    elif [ $MAIL = DYNAMIC ]; then
        njt_module_name=$MAIL_MODULES
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=$MAIL_SRCS
        njt_module_libs=
        njt_module_link=DYNAMIC

        . auto/module
    fi

    NJT_ADDON_DEPS="$NJT_ADDON_DEPS \$(MAIL_DEPS)"
fi


if [ $STREAM != NO ]; then

    if [ $USE_NTLS = YES ]; then
        have=NJT_STREAM_MULTICERT . auto/have
    fi

    if [ $STREAM = YES ]; then
        modules="$modules $STREAM_MODULES"

    elif [ $STREAM = DYNAMIC ]; then
        njt_module_name=$STREAM_MODULES
        njt_module_incs=
        njt_module_deps=
        njt_module_srcs=$STREAM_SRCS
        njt_module_libs=
        njt_module_link=DYNAMIC

        . auto/module
    fi

    NJT_ADDON_DEPS="$NJT_ADDON_DEPS \$(STREAM_DEPS)"
fi


njt_module_type=MISC
MISC_MODULES=

if [ $NJT_GOOGLE_PERFTOOLS = YES ]; then
    njt_module_name=njt_google_perftools_module
    njt_module_incs=
    njt_module_deps=
    njt_module_srcs=src/misc/njt_google_perftools_module.c
    njt_module_libs=
    njt_module_link=$NJT_GOOGLE_PERFTOOLS

    . auto/module
fi

if [ $NJT_CPP_TEST = YES ]; then
    njt_module_name=
    njt_module_incs=
    njt_module_deps=
    njt_module_srcs=src/misc/njt_cpp_test_module.cpp
    njt_module_libs=-lstdc++
    njt_module_link=$NJT_CPP_TEST

    . auto/module
fi

modules="$modules $MISC_MODULES"


if [ $NJT_COMPAT = YES ]; then
    have=NJT_COMPAT . auto/have
    have=NJT_HTTP_GZIP . auto/have
    have=NJT_HTTP_DAV . auto/have
    have=NJT_HTTP_REALIP . auto/have
    have=NJT_HTTP_X_FORWARDED_FOR . auto/have
    have=NJT_HTTP_HEADERS . auto/have
    have=NJT_HTTP_UPSTREAM_ZONE . auto/have
    have=NJT_STREAM_UPSTREAM_ZONE . auto/have
fi


cat << END                                    > $NJT_MODULES_C

#include <njt_config.h>
#include <njt_core.h>

$NJT_PRAGMA

END

for mod in $modules
do
    echo "extern njt_module_t  $mod;"         >> $NJT_MODULES_C
done

echo                                          >> $NJT_MODULES_C
echo 'njt_module_t *njt_modules[] = {'        >> $NJT_MODULES_C

for mod in $modules
do
    echo "    &$mod,"                         >> $NJT_MODULES_C
done

cat << END                                    >> $NJT_MODULES_C
    NULL
};

END

echo 'char *njt_module_names[] = {'           >> $NJT_MODULES_C

for mod in $modules
do
    echo "    \"$mod\","                      >> $NJT_MODULES_C
done

cat << END                                    >> $NJT_MODULES_C
    NULL
};

END
