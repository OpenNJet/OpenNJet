Name:     njet 
Version:  {{NJT_VERSION}} 
Release:  1%{?dist} 

Summary:  OpenNJet Application Engine
License:  MulanPSL-2.0  
URL:      https://gitee.com/njet-rd/njet    

#SOURCE0:  %{name}-%{version}.tar.gz
SOURCE0:  njet_main.tar

Requires(pre): shadow-utils
BuildRequires: systemd make gcc  gcc-c++ vim-common m4 autoconf automake cmake3 zlib-devel openssl-devel pcre-devel libtool libtool-ltdl pkgconfig

%description
OpenNJet 应用引擎是基于 NGINX 的面向互联网和云原生应用提供的运行时组态服务程序，作为底层引擎，OpenNJet 实现了NGINX 云原生功能增强、安全加固和代码重构，利用动态加载机制可以实现不同的产品形态，如Web服务器、流媒体服务器、负载均衡、代理(Proxy)、应用中间件、API网关、消息队列等产品形态等等。

%prep
%setup -q -c -n %{name}-%{version}

%build
mv njet_main njet
cd njet && sed -i 's/--strict-warnings//g' ./build_cc.sh && ./build_cc.sh {{NJT_BUILD_OPT}} conf && make -j `nproc`
./build_lua.sh

%install
rm -rf %{buildroot}
mkdir -p %{buildroot}/usr/local/njet/{apps,logs,data,modules,lib/tcc,sbin,lualib/lib,lualib/clib}
mkdir -p %{buildroot}/var/log/njet/logs
cd njet
DESTDIR=%{buildroot} ./build_cc.sh install 
cd ..
cp -a njet/build/rpm/njet.conf.files/* %{buildroot}
rm -f %{buildroot}/usr/local/njet/lib/*.a
cp -a njet/objs/scripts/so/* %{buildroot}/usr/local/njet/lualib/clib/
rm -rf njet/objs/scripts/so
cp -a njet/objs/scripts/* %{buildroot}/usr/local/njet/modules/

%pre
if [ "$1" -eq 1 ]; then
   if ! getent group njet >/dev/null 2>&1; then
     /usr/sbin/groupadd njet
   fi
   if ! getent passwd njet >/dev/null 2>&1; then
     /usr/sbin/useradd njet -g njet -M -s /sbin/nologin
   fi
fi

%post

grep -q /usr/local/lib /etc/ld.so.conf

if [ $? != 0 ] ; then
  echo "/usr/local/lib" >> /etc/ld.so.conf
fi

ldconfig

systemctl daemon-reload
systemctl enable njet.service

/usr/sbin/setcap cap_dac_override,cap_dac_read_search,cap_net_bind_service,cap_net_admin,cap_net_raw,cap_setuid=eip /usr/local/njet/sbin/njet

%preun
systemctl stop njet.service >/dev/null 2>&1
systemctl disable njet.service
systemctl daemon-reload

%postun

%clean
rm -rf %{buildroot}

%files
%defattr(-,root,root,-)
/etc/systemd/system/njet.service.d/filelimit.conf
/etc/ld.so.conf.d/njet.conf
%{_unitdir}/njet.service
%attr(-,njet,njet) /usr/local/njet/
%attr(-,njet,njet) /var/log/njet/logs/

%changelog
* Wed Nov 8 2023 hongxina <hongxina@tmlake.com> - 1.2.3-1
- update to 1.2.3 

* Wed Oct 18 2023 hongxina <hongxina@tmlake.com> - 1.2.2-1
- DESC: update to 1.2.2-1

* Tue Aug 15 2023 hongxina <hongxina@tmlake.com> - 1.1.2-1
- init 

